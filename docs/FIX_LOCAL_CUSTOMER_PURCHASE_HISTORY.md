# إصلاح مشكلة سجل مشتريات العميل المحلي

## المشكلة
عند فتح نموذج "سجل مشتريات العميل المحلي"، كان يظهر في حالة تحميل دائمة ولا يجلب سجل المشتريات بنجاح.

## السبب
كان هناك مشكلتان:
1. **Modal غير موجود**: لم يكن هناك modal HTML لعرض سجل المشتريات في الصفحة
2. **كود JavaScript غير مكتمل**: كان الكود يحتوي فقط على `console.log` ولا يستدعي API لجلب البيانات

## الحل المطبق ✅

### 1. إضافة Modal سجل المشتريات
تم إضافة modal كامل في `local_customers.php` (بعد السطر 6252):
- Modal بحجم XL مع جدول responsive
- عرض 7 أعمدة: رقم الفاتورة، التاريخ، المنتج، الكمية، سعر الوحدة، الإجمالي، رقم التشغيلة
- حالة تحميل افتراضية مع spinner
- زر إغلاق

### 2. إضافة كود AJAX لجلب البيانات
تم تحديث event listener في `local_customers.php` (السطور 6532-6590):
- استدعاء API: `/api/customer_purchase_history.php?action=get_history&customer_id={id}&type=local`
- عرض حالة التحميل مع spinner
- معالجة النتائج وعرضها في الجدول
- معالجة الأخطاء مع رسائل واضحة
- عرض رسالة "لا توجد مشتريات" إذا كانت القائمة فارغة

## الملفات المعدلة
1. `modules/manager/local_customers.php`:
   - إضافة modal HTML (السطور 6254-6299)
   - تحديث JavaScript event listener (السطور 6532-6590)

## API المستخدم
- **Endpoint**: `/api/customer_purchase_history.php`
- **Action**: `get_history`
- **Parameters**:
  - `customer_id`: معرف العميل (مطلوب)
  - `type`: نوع العميل (`local` للعملاء المحليين)

## البيانات المعروضة
- رقم الفاتورة
- تاريخ الفاتورة
- اسم المنتج
- الكمية (مع الوحدة)
- سعر الوحدة
- الإجمالي
- أرقام التشغيلات (إن وجدت)

## الاختبار
1. افتح صفحة العملاء المحليين
2. اضغط على زر "سجل المشتريات" لأي عميل
3. يجب أن يظهر modal مع:
   - حالة تحميل (spinner) لثوانٍ قليلة
   - قائمة المشتريات إذا كانت موجودة
   - رسالة "لا توجد مشتريات" إذا لم يكن هناك مشتريات
   - رسالة خطأ واضحة إذا حدث خطأ في التحميل

## ملاحظات
- API موجود ويعمل بشكل صحيح منذ البداية
- المشكلة كانت فقط في الواجهة الأمامية (Frontend)
- الحل يدعم العملاء المحليين فقط (`type=local`)
- للعملاء العاديين، استخدم `type=normal` (افتراضي)

## التاريخ
- **تاريخ الإصلاح**: 2026-01-08
- **النسخة**: 1.0
